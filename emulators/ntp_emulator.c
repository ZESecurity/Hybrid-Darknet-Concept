#include <stdbool.h>
#include <stdio.h>
#include <errno.h>
#include <string.h>
#include <unistd.h>
#include <netdb.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <string.h>
#include <unistd.h>
#include <stdlib.h>
#include <netinet/in.h>
#include <err.h>

int handle_datagram(char buffer[], int count){
    if (strstr(buffer,"\x17\x00\x03\x2a\x00\x00\x00\x00")!=NULL){
        //printf("Message received!\n");
        return 1;
    }
    else{
        return -1;
    }
}

int main(){
    //Create child(deamon) process
    pid_t process_id = fork();
    if (process_id<0){
        printf("Fork failure!\n");
        exit(1);
    }
    else if (process_id>0){
        //printf("Deamon process initialized!\n");
        //printf("Terminating parent process...\n");
        exit(0);
    }
    
    //IP address and port converted from string to struct sockaddr_in
    const char* hostname="0.0.0.0"; /* wildcard */
    const char* portname="123";
   	struct addrinfo hints;
    
    //Content to reflect back
   	char content[]={0xec,0x2b,0x6f,0x5a,0x1f,0x37,0x07,0xce,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x21,0x20,0x22,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x09,0xbc,0x22,0x00,0x08,0x44,0x02,0x00,0x00,0x2c,0x01,0x01,0x00,0x04,0x03,0x00,0x00,0x0c,0x01,0x00,0x00,0x14,0x80,0x0e,0x01,0x00,0x03,0x00,0x00,0x08,0x03,0x00,0x00,0x00,0x03,0x00,0x00,0x08,0x02,0x00,0x00,0x02,0x00,0x00,0x00,0x08,0x04,0x00,0x00,0x0e,0x02,0x00,0x00,0x2c,0x02,0x01,0x00,0x04,0x03,0x00,0x00,0x0c,0x01,0x00,0x00,0x14,0x80,0x0e,0x01,0x00,0x03,0x00,0x00,0x08,0x03,0x00,0x00,0x00,0x03,0x00,0x00,0x08,0x02,0x00,0x00,0x02,0x00,0x00,0x00,0x08,0x04,0x00,0x00,0x0e,0x02,0x00,0x00,0x2c,0x03,0x01,0x00,0x04,0x03,0x00,0x00,0x0c,0x01,0x00,0x00,0x14,0x80,0x0e,0x01,0x00,0x03,0x00,0x00,0x08,0x03,0x00,0x00,0x00,0x03,0x00,0x00,0x08,0x02,0x00,0x00,0x05,0x00,0x00,0x00,0x08,0x04,0x00,0x00,0x0e,0x02,0x00,0x00,0x2c,0x04,0x01,0x00,0x04,0x03,0x00,0x00,0x0c,0x01,0x00,0x00,0x14,0x80,0x0e,0x01,0x00,0x03,0x00,0x00,0x08,0x03,0x00,0x00,0x00,0x03,0x00,0x00,0x08,0x02,0x00,0x00,0x05,0x00,0x00,0x00,0x08,0x04,0x00,0x00,0x0e,0x02,0x00,0x00,0x2c,0x05,0x01,0x00,0x04,0x03,0x00,0x00,0x0c,0x01,0x00,0x00,0x14,0x80,0x0e,0x01,0x00,0x03,0x00,0x00,0x08,0x03,0x00,0x00,0x00,0x03,0x00,0x00,0x08,0x02,0x00,0x00,0x02,0x00,0x00,0x00,0x08,0x04,0x00,0x00,0x10,0x02,0x00,0x00,0x2c,0x06,0x01,0x00,0x04,0x03,0x00,0x00,0x0c,0x01,0x00,0x00,0x14,0x80,0x0e,0x01,0x00,0x03,0x00,0x00,0x08,0x03,0x00,0x00,0x00,0x03,0x00,0x00,0x08,0x02,0x00,0x00,0x02,0x00,0x00,0x00,0x08,0x04,0x00,0x00,0x10,0x02,0x00,0x00,0x2c,0x07,0x01,0x00,0x04,0x03,0x00,0x00,0x0c,0x01,0x00,0x00,0x14,0x80,0x0e,0x01,0x00,0x03,0x00,0x00,0x08,0x03,0x00,0x00,0x00,0x03,0x00,0x00,0x08,0x02,0x00,0x00,0x05,0x00,0x00,0x00,0x08,0x04,0x00,0x00,0x10,0x02,0x00,0x00,0x2c,0x08,0x01,0x00,0x04,0x03,0x00,0x00,0x0c,0x01,0x00,0x00,0x14,0x80,0x0e,0x01,0x00,0x03,0x00,0x00,0x08,0x03,0x00,0x00,0x00,0x03,0x00,0x00,0x08,0x02,0x00,0x00,0x05,0x00,0x00,0x00,0x08,0x04,0x00,0x00,0x10,0x02,0x00,0x00,0x2c,0x09,0x01,0x00,0x04,0x03,0x00,0x00,0x0c,0x01,0x00,0x00,0x14,0x80,0x0e,0x01,0x00,0x03,0x00,0x00,0x08,0x03,0x00,0x00,0x00,0x03,0x00,0x00,0x08,0x02,0x00,0x00,0x02,0x00,0x00,0x00,0x08,0x04,0x00,0x00,0x12,0x02,0x00,0x00,0x2c,0x0a,0x01,0x00,0x04,0x03,0x00,0x00,0x0c,0x01,0x00,0x00,0x14,0x80,0x0e,0x01,0x00,0x03,0x00,0x00,0x08,0x03,0x00,0x00,0x00,0x03,0x00,0x00,0x08,0x02,0x00,0x00,0x02,0x00,0x00,0x00,0x08,0x04,0x00,0x00,0x12,0x02,0x00,0x00,0x2c,0x0b,0x01,0x00,0x04,0x03,0x00,0x00,0x0c,0x01,0x00,0x00,0x14,0x80,0x0e,0x01,0x00,0x03,0x00,0x00,0x08,0x03,0x00,0x00,0x00,0x03,0x00,0x00,0x08,0x02,0x00,0x00,0x05,0x00,0x00,0x00,0x08,0x04,0x00,0x00,0x12,0x02,0x00,0x00,0x2c,0x0c,0x01,0x00,0x04,0x03,0x00,0x00,0x0c,0x01,0x00,0x00,0x14,0x80,0x0e,0x01,0x00,0x03,0x00,0x00,0x08,0x03,0x00,0x00,0x00,0x03,0x00,0x00,0x08,0x02,0x00,0x00,0x05,0x00,0x00,0x00,0x08,0x04,0x00,0x00,0x12,0x02,0x00,0x00,0x2c,0x0d,0x01,0x00,0x04,0x03,0x00,0x00,0x0c,0x01,0x00,0x00,0x14,0x80,0x0e,0x00,0x80,0x03,0x00,0x00,0x08,0x03,0x00,0x00,0x00,0x03,0x00,0x00,0x08,0x02,0x00,0x00,0x02,0x00,0x00,0x00,0x08,0x04,0x00,0x00,0x0e,0x02,0x00,0x00,0x2c,0x0e,0x01,0x00,0x04,0x03,0x00,0x00,0x0c,0x01,0x00,0x00,0x14,0x80,0x0e,0x00,0x80,0x03,0x00,0x00,0x08,0x03,0x00,0x00,0x00,0x03,0x00,0x00,0x08,0x02,0x00,0x00,0x02,0x00,0x00,0x00,0x08,0x04,0x00,0x00,0x0e,0x02,0x00,0x00,0x2c,0x0f,0x01,0x00,0x04,0x03,0x00,0x00,0x0c,0x01,0x00,0x00,0x14,0x80,0x0e,0x00,0x80,0x03,0x00,0x00,0x08,0x03,0x00,0x00,0x00,0x03,0x00,0x00,0x08,0x02,0x00,0x00,0x05,0x00,0x00,0x00,0x08,0x04,0x00,0x00,0x0e,0x02,0x00,0x00,0x2c,0x10,0x01,0x00,0x04,0x03,0x00,0x00,0x0c,0x01,0x00,0x00,0x14,0x80,0x0e,0x00,0x80,0x03,0x00,0x00,0x08,0x03,0x00,0x00,0x00,0x03,0x00,0x00,0x08,0x02,0x00,0x00,0x05,0x00,0x00,0x00,0x08,0x04,0x00,0x00,0x0e,0x02,0x00,0x00,0x2c,0x11,0x01,0x00,0x04,0x03,0x00,0x00,0x0c,0x01,0x00,0x00,0x14,0x80,0x0e,0x00,0x80,0x03,0x00,0x00,0x08,0x03,0x00,0x00,0x00,0x03,0x00,0x00,0x08,0x02,0x00,0x00,0x02,0x00,0x00,0x00,0x08,0x04,0x00,0x00,0x10,0x02,0x00,0x00,0x2c,0x12,0x01,0x00,0x04,0x03,0x00,0x00,0x0c,0x01,0x00,0x00,0x14,0x80,0x0e,0x00,0x80,0x03,0x00,0x00,0x08,0x03,0x00,0x00,0x00,0x03,0x00,0x00,0x08,0x02,0x00,0x00,0x02,0x00,0x00,0x00,0x08,0x04,0x00,0x00,0x10,0x02,0x00,0x00,0x2c,0x13,0x01,0x00,0x04,0x03,0x00,0x00,0x0c,0x01,0x00,0x00,0x14,0x80,0x0e,0x00,0x80,0x03,0x00,0x00,0x08,0x03,0x00,0x00,0x00,0x03,0x00,0x00,0x08,0x02,0x00,0x00,0x05,0x00,0x00,0x00,0x08,0x04,0x00,0x00,0x10,0x02,0x00,0x00,0x2c,0x14,0x01,0x00,0x04,0x03,0x00,0x00,0x0c,0x01,0x00,0x00,0x14,0x80,0x0e,0x00,0x80,0x03,0x00,0x00,0x08,0x03,0x00,0x00,0x00,0x03,0x00,0x00,0x08,0x02,0x00,0x00,0x05,0x00,0x00,0x00,0x08,0x04,0x00,0x00,0x10,0x02,0x00,0x00,0x2c,0x15,0x01,0x00,0x04,0x03,0x00,0x00,0x0c,0x01,0x00,0x00,0x14,0x80,0x0e,0x00,0x80,0x03,0x00,0x00,0x08,0x03,0x00,0x00,0x00,0x03,0x00,0x00,0x08,0x02,0x00,0x00,0x02,0x00,0x00,0x00,0x08,0x04,0x00,0x00,0x12,0x02,0x00,0x00,0x2c,0x16,0x01,0x00,0x04,0x03,0x00,0x00,0x0c,0x01,0x00,0x00,0x14,0x80,0x0e,0x00,0x80,0x03,0x00,0x00,0x08,0x03,0x00,0x00,0x00,0x03,0x00,0x00,0x08,0x02,0x00,0x00,0x02,0x00,0x00,0x00,0x08,0x04,0x00,0x00,0x12,0x02,0x00,0x00,0x2c,0x17,0x01,0x00,0x04,0x03,0x00,0x00,0x0c,0x01,0x00,0x00,0x14,0x80,0x0e,0x00,0x80,0x03,0x00,0x00,0x08,0x03,0x00,0x00,0x00,0x03,0x00,0x00,0x08,0x02,0x00,0x00,0x05,0x00,0x00,0x00,0x08,0x04,0x00,0x00,0x12,0x02,0x00,0x00,0x2c,0x18,0x01,0x00,0x04,0x03,0x00,0x00,0x0c,0x01,0x00,0x00,0x14,0x80,0x0e,0x00,0x80,0x03,0x00,0x00,0x08,0x03,0x00,0x00,0x00,0x03,0x00,0x00,0x08,0x02,0x00,0x00,0x05,0x00,0x00,0x00,0x08,0x04,0x00,0x00,0x12,0x02,0x00,0x00,0x2c,0x19,0x01,0x00,0x04,0x03,0x00,0x00,0x0c,0x01,0x00,0x00,0x0c,0x80,0x0e,0x01,0x00,0x03,0x00,0x00,0x08,0x03,0x00,0x00,0x02,0x03,0x00,0x00,0x08,0x02,0x00,0x00,0x02,0x00,0x00,0x00,0x08,0x04,0x00,0x00,0x05,0x02,0x00,0x00,0x2c,0x1a,0x01,0x00,0x04,0x03,0x00,0x00,0x0c,0x01,0x00,0x00,0x0c,0x80,0x0e,0x01,0x00,0x03,0x00,0x00,0x08,0x03,0x00,0x00,0x02,0x03,0x00,0x00,0x08,0x02,0x00,0x00,0x02,0x00,0x00,0x00,0x08,0x04,0x00,0x00,0x05,0x02,0x00,0x00,0x2c,0x1b,0x01,0x00,0x04,0x03,0x00,0x00,0x0c,0x01,0x00,0x00,0x0c,0x80,0x0e,0x01,0x00,0x03,0x00,0x00,0x08,0x03,0x00,0x00,0x0c,0x03,0x00,0x00,0x08,0x02,0x00,0x00,0x05,0x00,0x00,0x00,0x08,0x04,0x00,0x00,0x05,0x02,0x00,0x00,0x2c,0x1c,0x01,0x00,0x04,0x03,0x00,0x00,0x0c,0x01,0x00,0x00,0x0c,0x80,0x0e,0x01,0x00,0x03,0x00,0x00,0x08,0x03,0x00,0x00,0x0c,0x03,0x00,0x00,0x08,0x02,0x00,0x00,0x05,0x00,0x00,0x00,0x08,0x04,0x00,0x00,0x05,0x02,0x00,0x00,0x2c,0x1d,0x01,0x00,0x04,0x03,0x00,0x00,0x0c,0x01,0x00,0x00,0x0c,0x80,0x0e,0x01,0x00,0x03,0x00,0x00,0x08,0x03,0x00,0x00,0x05,0x03,0x00,0x00,0x08,0x02,0x00,0x00,0x04,0x00,0x00,0x00,0x08,0x04,0x00,0x00,0x05,0x02,0x00,0x00,0x2c,0x1e,0x01,0x00,0x04,0x03,0x00,0x00,0x0c,0x01,0x00,0x00,0x0c,0x80,0x0e,0x01,0x00,0x03,0x00,0x00,0x08,0x03,0x00,0x00,0x05,0x03,0x00,0x00,0x08,0x02,0x00,0x00,0x04,0x00,0x00,0x00,0x08,0x04,0x00,0x00,0x05,0x02,0x00,0x00,0x2c,0x1f,0x01,0x00,0x04,0x03,0x00,0x00,0x0c,0x01,0x00,0x00,0x0c,0x80,0x0e,0x01,0x00,0x03,0x00,0x00,0x08,0x03,0x00,0x00,0x02,0x03,0x00,0x00,0x08,0x02,0x00,0x00,0x02,0x00,0x00,0x00,0x08,0x04,0x00,0x00,0x0e,0x02,0x00,0x00,0x2c,0x20,0x01,0x00,0x04,0x03,0x00,0x00,0x0c,0x01,0x00,0x00,0x0c,0x80,0x0e,0x01,0x00,0x03,0x00,0x00,0x08,0x03,0x00,0x00,0x02,0x03,0x00,0x00,0x08,0x02,0x00,0x00,0x02,0x00,0x00,0x00,0x08,0x04,0x00,0x00,0x0e,0x02,0x00,0x00,0x2c,0x21,0x01,0x00,0x04,0x03,0x00,0x00,0x0c,0x01,0x00,0x00,0x0c,0x80,0x0e,0x00,0x00,0xee,0x01,0x81,0xa9,0x78,0x04,0x00,0x00,0xf2,0xa4,0x3a,0x56};
    while(1){
        memset(&hints,0,sizeof(hints));
        hints.ai_family=AF_INET;
        hints.ai_socktype=SOCK_DGRAM;
        hints.ai_protocol=0;
        hints.ai_flags=AI_PASSIVE|AI_ADDRCONFIG;
        
        struct addrinfo* res=0;
        int err = getaddrinfo(hostname,portname,&hints,&res);
        if (err!=0) {
            printf("ERROR");
        }
        //Create socket
        int fd=socket(res->ai_family,res->ai_socktype,res->ai_protocol);
        if (fd==-1) {
            printf("ERROR: socket");
        }
        //Bind socket
        if (bind(fd,res->ai_addr,res->ai_addrlen)==-1) {
            printf("ERROR: bind");
        }
        //Receive and handle datagrams
        char buffer[1549];
        struct sockaddr_in src_addr;
        socklen_t src_addr_len;
        ssize_t count;
        
        count = recvfrom(fd,buffer,sizeof(buffer),0,(struct sockaddr*)&src_addr,&src_addr_len);
        if (count==-1) {
            printf("ERROR: count=-1");
        }
        else if (count==sizeof(buffer)) {
            warn("datagram too large for buffer: truncated");
        }
        else {//Sending response
            if (handle_datagram(buffer,count)==1){
                sendto(fd,content,sizeof(content),0,(struct sockaddr*)&src_addr,src_addr_len);
            }
        }
        memset(&buffer[0],0,sizeof(buffer));
        close(fd);
    }
    return 0;
}

